<!DOCTYPE html>
<html>
  <head>
    <title>D√©tail du projet</title>
    <style>
      .container {
        max-width: 600px;
        margin: 2rem auto;
        border: 1px solid #ddd;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
      }
      img {
        max-width: 100%;
        border-radius: 8px;
      }
      .actions {
        margin-top: 1.5rem;
      }
      .favorite-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 0.5rem;
      }
    </style>
  </head>
  <body>
    {{#if notFound}}
      <p>Projet introuvable.</p>
    {{else if accessDenied}}
      <p>Acc√®s refus√©.</p>
    {{else}}
      <div class="container">
        <h1>
          {{project.file}}
          <button id="favorite-btn" class="favorite-btn" onclick="toggleFavorite(event, {{project.id}})">
            {{#if isFavorite}}‚ù§Ô∏è{{else}}ü§ç{{/if}}
          </button>
        </h1>

        {{#if project.imageurl}}
          <img src="{{project.imageurl}}" alt="Image du projet" />
        {{/if}}

        <p><strong>Montant demand√© :</strong> {{project.amount}} ‚Ç¨</p>
        <p><strong>Cr√©√© par :</strong> {{project.ownerName}}</p>

        {{#unless isOwner}}
          <button onclick="toggleMessageForm()">‚úâÔ∏è Contacter le cr√©ateur</button>

          <div id="message-popup" style="display: none; margin-top: 1rem;">
            <textarea id="message-content" placeholder="Votre message..."></textarea>
            <button onclick="sendMessage({{project.id}})">Envoyer</button>
            <p id="message-status"></p>
          </div>
        {{/unless}}

        {{#if isOwner}}
          <div class="actions">
            <form method="POST" action="/pitch-deck/{{project.id}}/delete">
              <button type="submit">üóëÔ∏è Supprimer</button>
            </form>
            <form method="GET" action="/pitch-deck/{{project.id}}/edit">
              <button type="submit">‚úèÔ∏è Modifier</button>
            </form>
          </div>
        {{else}}
          {{#if (eq user.role "investor")}}
            <div class="actions">
              <form id="offer-form">
                <label for="amount">Faire une offre üí∞ (‚Ç¨)</label>
                <input type="number" name="amount" id="offer-amount" required min="1" step="any" />
                <button type="submit">Proposer</button>
              </form>
              <p id="offer-message" style="color: green;"></p>
            </div>
          {{/if}}
        {{/if}}
      </div>
    {{/if}}

    <p><a href="/accueil">‚¨ÖÔ∏è Retour</a></p>

    <script>
      async function toggleFavorite(event, pitchdeckId) {
        event.preventDefault();
        const res = await fetch(`/favorites/toggle/${pitchdeckId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          const { favorited } = await res.json();
          const btn = document.getElementById('favorite-btn');
          if (btn) btn.textContent = favorited ? '‚ù§Ô∏è' : 'ü§ç';
        } else {
          alert("Erreur lors de l'ajout/suppression du favori.");
        }
      }

      const offerForm = document.getElementById('offer-form');
      if (offerForm) {
        offerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const amount = document.getElementById('offer-amount').value;
          const pitchdeckId = {{project.id}};

          const res = await fetch(`/projets/${pitchdeckId}/offre`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: parseFloat(amount) }),
          });

          const msg = document.getElementById('offer-message');
          if (res.ok) {
            msg.textContent = '‚úÖ Offre envoy√©e avec succ√®s !';
          } else {
            msg.textContent = '‚ùå Une erreur est survenue.';
          }
        });
      }

        function toggleMessageForm() {
          const popup = document.getElementById("message-popup");
          popup.style.display = popup.style.display === "none" ? "block" : "none";
        }

        async function sendMessage(projectId) {
          const content = document.getElementById("message-content").value;
          const status = document.getElementById("message-status");

          const res = await fetch(`/projets/${projectId}/message`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content }),
          });

          if (res.ok) {
            status.textContent = "‚úÖ Message envoy√© !";
          } else {
            status.textContent = "‚ùå Erreur lors de l'envoi.";
          }
        }
    </script>
  </body>
</html>
